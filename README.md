# 地平线J5 H265硬件编码流程

**可调节的参数：分辨率，GOP Size 关键帧 码率 等等 ， 有一个duration时长，大概意思是说 ，YUV播放的时长 等于压缩的时长，单位为ms。**

### 总结H265压缩流程

该程序实现了一个H265视频编码的流程，主要功能是将输入的视频文件（通常是YUV格式）进行H265编码，并将编码后的数据输出到一个文件中。程序通过同步方式处理视频帧，完成编码过程。以下是详细的流程总结：

1. **初始化**：
   - 程序首先获取当前时间并初始化编码器。通过调用`hb_mm_mc_initialize()`来初始化编码器上下文（`context`）。
   - 接着通过`hb_mm_mc_configure()`配置编码器参数，设置视频编码的一些基础配置。
   - 然后，通过`hb_mm_mc_start()`启动编码器，准备编码。
2. **输入数据的处理**：
   - 程序从输入文件中读取YUV数据进行编码。每次读取的数据会被放入输入缓冲区（`inputBuffer`）中。
   - 每次读取时，程序首先检查是否已经读取完数据，如果数据已经读取完，则会将`frame_end`标志设置为1，表示没有更多输入数据。
3. **视频编码**：
   - 将填充好的输入数据通过`hb_mm_mc_queue_input_buffer()`提交给编码器进行处理。
   - 编码器会对输入数据进行压缩，并通过`hb_mm_mc_dequeue_output_buffer()`获取编码后的输出数据。
   - 编码后的数据会写入输出文件中，直到输出流结束，最后会释放资源。
4. **延迟计算**：
   - 每次进行编码时，程序记录编码的开始时间和结束时间，并计算编码延迟，输出编码的延迟时间。
5. **清理和释放资源**：
   - 编码完成后，程序会调用`hb_mm_mc_stop()`停止编码器并通过`hb_mm_mc_release()`释放资源。

### 流程图

以下是根据上述步骤给出的H265编码流程标准流程图：

```plaintext
+---------------------------------------+
|              初始化编码器              |
|   - 获取当前时间                       |
|   - 初始化编码器上下文 (hb_mm_mc_initialize) |
|   - 配置编码器参数 (hb_mm_mc_configure) |
|   - 启动编码器 (hb_mm_mc_start)         |
+---------------------------------------+
                 |
                 v
+---------------------------------------+
|         从输入文件读取数据            |
|   - 读取YUV数据到inputBuffer          |
|   - 检查是否有更多数据                |
+---------------------------------------+
                 |
                 v
+---------------------------------------+
|        提交输入数据进行编码            |
|   - 将数据送入编码器 (hb_mm_mc_queue_input_buffer) |
+---------------------------------------+
                 |
                 v
+---------------------------------------+
|          获取编码后的输出数据         |
|   - 从编码器获取输出数据 (hb_mm_mc_dequeue_output_buffer) |
|   - 将输出数据写入文件                |
+---------------------------------------+
                 |
                 v
+---------------------------------------+
|       计算编码延迟                    |
|   - 记录编码开始时间和结束时间       |
|   - 计算并输出编码延迟                |
+---------------------------------------+
                 |
                 v
+---------------------------------------+
|              结束编码并释放资源       |
|   - 停止编码器 (hb_mm_mc_stop)         |
|   - 释放资源 (hb_mm_mc_release)       |
+---------------------------------------+
```

### 编译说明

环境：ARMV8 平台 GCC
